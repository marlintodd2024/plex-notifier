<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingeAlert - Admin Dashboard</title>
    <style>
        /* Dark Mode Only - No Switching */
        :root {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #e4e4e4;
            --text-secondary: #999;
            --accent-primary: #e5a00d;
            --accent-secondary: #f4c542;
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
        }

        select {
            background-color: #1e2140 !important;
            color: #e4e4e4 !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
            padding-right: 32px !important;
        }

        select option {
            background-color: #1e2140;
            color: #e4e4e4;
            padding: 8px;
        }

        /* Custom dropdown wrapper - replaces native select on Windows */
        .custom-select-wrap {
            position: relative;
            width: 100%;
        }

        .custom-select-display {
            width: 100%;
            padding: 10px 32px 10px 10px;
            background: #1e2140;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #e4e4e4;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            position: relative;
        }

        .custom-select-display::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #999;
        }

        .custom-select-display:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .custom-select-options {
            display: none;
            position: fixed;
            background: #1e2140;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 99999;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .custom-select-options.open {
            display: block;
        }

        .custom-select-option {
            padding: 10px 12px;
            color: #e4e4e4;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
        }

        .custom-select-option:hover {
            background: rgba(229, 160, 13, 0.2);
        }

        .custom-select-option.selected {
            background: rgba(229, 160, 13, 0.15);
            color: #e5a00d;
        }

        .custom-select-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .custom-select-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }



        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(229, 160, 13, 0.2);
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #e5a00d;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .action-group {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .action-group-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #888;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .action-group-title.danger-title {
            color: #e57373;
        }

        .action-group .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .action-group button {
            flex: 1 1 auto;
            min-width: 0;
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 8px;
            white-space: nowrap;
        }

        button {
            background: linear-gradient(45deg, #e5a00d, #f4c542);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(229, 160, 13, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e4e4e4;
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.2);
        }

        button.danger {
            background: #f44336;
            color: white;
        }

        button.danger:hover {
            background: #d32f2f;
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #e5a00d;
            border-bottom-color: #e5a00d;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(229, 160, 13, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #e5a00d;
            border-bottom: 2px solid rgba(229, 160, 13, 0.3);
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: rgba(229, 160, 13, 0.15);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .badge.approved {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .badge.available {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .badge.sent {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .badge.pending-email {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .badge.movie {
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
        }

        .badge.tv {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #e5a00d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Config page styles */
        .config-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .config-section h3 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .config-grid {
            display: grid;
            gap: 15px;
        }

        .config-input {
            width: 100%;
            max-width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .config-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .config-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 5px;
            font-weight: normal;
        }

        .config-field {
            margin-bottom: 15px;
        }

        .config-field small {
            display: block;
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 15px;
            color: #e4e4e4;
            width: 300px;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #e5a00d;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                overflow-x: auto;
            }

            .actions {
                grid-template-columns: 1fr;
            }

            .action-group button {
                width: 100%;
            }
        }

        .last-sync {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0 5px;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.1);
            transition: .3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #e5a00d;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h1>üé¨ BingeAlert</h1>
                <p class="subtitle">Admin Dashboard</p>
                <div class="last-sync" id="lastSync">Last sync: Never</div>
            </div>
            <button onclick="doLogout()" class="secondary" id="logoutBtn" 
                    style="padding: 8px 16px; font-size: 12px; display: none;">
                üîí Logout
            </button>
        </header>

        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="stats-grid">
            <div class="stat-card" style="cursor: pointer;" onclick="switchTab('users', event)">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card" style="cursor: pointer;" onclick="switchTab('requests', event)">
                <div class="stat-label">Total Requests</div>
                <div class="stat-value" id="totalRequests">-</div>
            </div>
            <div class="stat-card" style="cursor: pointer;" onclick="showTrackingRequests()">
                <div class="stat-label">‚è≥ Tracking (Waiting)</div>
                <div class="stat-value" id="trackingRequests">-</div>
            </div>
            <div class="stat-card" style="cursor: pointer;" onclick="switchTab('upcoming', event)">
                <div class="stat-label">Episodes Tracked</div>
                <div class="stat-value" id="episodesTracked">-</div>
            </div>
            <div class="stat-card" style="cursor: pointer;" onclick="showSentNotifications()">
                <div class="stat-label">Notifications Sent</div>
                <div class="stat-value" id="notificationsSent">-</div>
            </div>
            <div class="stat-card" style="cursor: pointer;" onclick="showPendingNotifications()">
                <div class="stat-label">Pending Notifications</div>
                <div class="stat-value" id="notificationsPending">-</div>
            </div>
        </div>

        <div class="actions">
            <div class="action-group">
                <div class="action-group-title">Sync</div>
                <div class="action-buttons">
                    <button onclick="syncUsers()" id="syncUsersBtn">üîÑ Users</button>
                    <button onclick="syncRequests()" id="syncRequestsBtn">üîÑ Requests</button>
                    <button onclick="importAllEpisodes()" id="importEpisodesBtn">üì• Episodes</button>
                </div>
            </div>

            <div class="action-group">
                <div class="action-group-title">Notifications</div>
                <div class="action-buttons">
                    <button onclick="processNotifications()" id="processNotifBtn">üìß Process Queue</button>
                    <button onclick="showTestEmailModal()" class="secondary">‚úâÔ∏è Test Email</button>
                    <button onclick="sendWeeklySummary()" id="summaryBtn" class="secondary">üìä Summary</button>
                </div>
            </div>

            <div class="action-group">
                <div class="action-group-title">Monitoring</div>
                <div class="action-buttons">
                    <button onclick="runReconciliation()" id="reconcileBtn" class="secondary">üîç Check Missed</button>
                    <button onclick="checkStuckDownloads()" id="stuckBtn" class="secondary">‚ö†Ô∏è Stuck Downloads</button>
                    <button onclick="checkQualityRelease()" id="qualityCheckBtn" class="secondary">üìÖ Quality/Release</button>
                </div>
            </div>

            <div class="action-group">
                <div class="action-group-title danger-title">Maintenance</div>
                <div class="action-buttons">
                    <button onclick="refreshData()" class="secondary">‚ôªÔ∏è Refresh</button>
                    <button onclick="clearOldNotifications()" id="clearOldBtn" class="danger">üóëÔ∏è Clear Old</button>
                    <button onclick="clearAllPending()" id="clearAllBtn" class="danger" style="background: #c62828;">‚ö†Ô∏è Clear All</button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('users', event)">üë• Users</div>
            <div class="tab" onclick="switchTab('requests', event)">üìã Requests</div>
            <div class="tab" onclick="switchTab('notifications', event)">üìß Notifications</div>
            <div class="tab" onclick="switchTab('issues', event)">üö® Issues</div>
            <div class="tab" onclick="switchTab('upcoming', event)">üìÖ Upcoming Episodes</div>
            <div class="tab" onclick="switchTab('backup', event)">üíæ Backup</div>
            <div class="tab" onclick="switchTab('settings', event)">‚öôÔ∏è Settings</div>
            <div class="tab" onclick="switchTab('logs', event)">üìã Logs</div>
        </div>

        <div id="usersTab" class="tab-content active">
            <input type="text" class="search-box" placeholder="Search users..." id="userSearch" oninput="filterUsers()">
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('users', 'id')">ID</th>
                            <th class="sortable" onclick="sortTable('users', 'username')">Username</th>
                            <th class="sortable" onclick="sortTable('users', 'email')">Email</th>
                            <th class="sortable" onclick="sortTable('users', 'jellyseerr_id')">Jellyseerr ID</th>
                            <th class="sortable" onclick="sortTable('users', 'created_at')">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="requestsTab" class="tab-content">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" class="search-box" placeholder="Search requests..." id="requestSearch" oninput="filterRequests()" style="flex: 1;">
                <button onclick="openRequestOnBehalfModal()" class="secondary" style="background: rgba(138, 43, 226, 0.2); border-color: #8a2be2; color: #8a2be2;">
                    üé¨ Request on Behalf of User
                </button>
                <button onclick="filterRequestsByType('all')" id="requestFilterAll" class="secondary" style="background: #e5a00d;">All</button>
                <button onclick="filterRequestsByType('tv')" id="requestFilterTV" class="secondary">üì∫ TV Shows</button>
                <button onclick="filterRequestsByType('movie')" id="requestFilterMovie" class="secondary">üé¨ Movies</button>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('requests', 'id')">ID</th>
                            <th class="sortable" onclick="sortTable('requests', 'user_email')">User Email</th>
                            <th class="sortable" onclick="sortTable('requests', 'media_type')">Type</th>
                            <th class="sortable" onclick="sortTable('requests', 'title')">Title</th>
                            <th class="sortable" onclick="sortTable('requests', 'status')">Status</th>
                            <th class="sortable" onclick="sortTable('requests', 'created_at')">Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody">
                        <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading requests...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="notificationsTab" class="tab-content">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" class="search-box" placeholder="Search notifications..." id="notificationSearch" oninput="filterNotifications()" style="flex: 1;">
                <button onclick="filterNotificationsByType('all')" id="notificationFilterAll" class="secondary" style="background: #e5a00d;">All</button>
                <button onclick="filterNotificationsByType('episode')" id="notificationFilterTV" class="secondary">üì∫ TV Shows</button>
                <button onclick="filterNotificationsByType('movie')" id="notificationFilterMovie" class="secondary">üé¨ Movies</button>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('notifications', 'id')">ID</th>
                            <th class="sortable" onclick="sortTable('notifications', 'user_email')">User Email</th>
                            <th class="sortable" onclick="sortTable('notifications', 'type')">Type</th>
                            <th class="sortable" onclick="sortTable('notifications', 'subject')">Subject</th>
                            <th class="sortable" onclick="sortTable('notifications', 'sent')">Status</th>
                            <th class="sortable" onclick="sortTable('notifications', 'created_at')">Created At</th>
                            <th class="sortable" onclick="sortTable('notifications', 'sent_at')">Sent At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="notificationsTableBody">
                        <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading notifications...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Issues Tab -->
        <div id="issuesTab" class="tab-content">
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <input type="text" class="search-box" placeholder="Search issues..." id="issueSearch" oninput="filterIssues()" style="flex: 1;">
                <select id="issueStatusFilter" onchange="filterIssues()" style="padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    <option value="all">All Statuses</option>
                    <option value="reported">Reported</option>
                    <option value="fixing">Fixing</option>
                    <option value="resolved">Resolved</option>
                    <option value="failed">Failed</option>
                </select>
                <button onclick="loadIssues()" class="secondary" style="padding: 10px 15px;">üîÑ Refresh</button>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Issue</th>
                            <th>Message</th>
                            <th>Reported By</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="upcomingTab" class="tab-content">
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <input type="text" class="search-box" placeholder="Search series or episodes..." id="upcomingSearch" oninput="filterUpcoming()" style="flex: 1;">
                <select id="upcomingUserFilter" onchange="filterUpcoming()" style="padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    <option value="all">All Users</option>
                </select>
                <select id="upcomingDays" onchange="loadUpcoming()" style="padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    <option value="7">Next 7 Days</option>
                    <option value="14">Next 14 Days</option>
                    <option value="30" selected">Next 30 Days</option>
                    <option value="60">Next 60 Days</option>
                </select>
                <button onclick="toggleUpcomingView()" id="viewToggleBtn" style="padding: 10px 15px; background: rgba(229,160,13,0.2); border: 1px solid #e5a00d; border-radius: 8px; color: #e5a00d; cursor: pointer;">
                    üìã Switch to List View
                </button>
            </div>
            
            <!-- Grouped View -->
            <div id="upcomingGroupedView" style="display: block;">
                <div id="upcomingGroupedContent">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div class="spinner"></div>
                        <p>Loading upcoming episodes...</p>
                    </div>
                </div>
            </div>
            
            <!-- Table View (hidden by default) -->
            <div id="upcomingTableView" class="data-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('upcoming', 'series_title')">Series</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'season_number')">Episode</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'episode_title')">Title</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'air_date')">Air Date</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'has_file')">Downloaded</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'user_name')">User</th>
                            <th class="sortable" onclick="sortTable('upcoming', 'already_notified')">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="upcomingTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="backupTab" class="tab-content">
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #e5a00d;">üíæ Create Backup</h3>
                <p style="color: #999; margin-bottom: 15px;">Create a backup of your database and configuration. Backups include all users, requests, notifications, and episode tracking. API keys and passwords are NOT included for security.</p>
                <button onclick="createBackup()" id="createBackupBtn">üíæ Create Backup</button>
            </div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #e5a00d;">üì§ Restore Backup</h3>
                <p style="color: #999; margin-bottom: 15px;">Upload a backup file to restore your data. <strong style="color: #f44336;">Warning:</strong> This will replace all current data!</p>
                <input type="file" id="restoreFileInput" accept=".zip" style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4; width: 100%;">
                <button onclick="restoreBackup()" id="restoreBackupBtn">üì§ Restore Backup</button>
            </div>

            <h3 style="margin-bottom: 15px; color: #e5a00d;">Available Backups</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Created</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backupsTableBody">
                        <tr><td colspan="4" class="loading"><div class="spinner"></div>Loading backups...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="settingsTab" class="tab-content">
            <!-- Batch Timing Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">‚è±Ô∏è Smart Batching Settings</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    The portal automatically groups multiple episodes into single emails to prevent notification spam. 
                    When an episode downloads, it waits for more episodes and intelligently batches them together.
                </p>
                
                <div style="background: rgba(229, 160, 13, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e5a00d;">
                    <strong style="color: #e5a00d;">How it works:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        1. Episode downloads ‚Üí Wait <strong>Initial Delay</strong> for Plex to index<br>
                        2. Check Sonarr queue ‚Üí More episodes coming? Extend by <strong>Extension</strong> minutes<br>
                        3. Keep checking every <strong>Check Frequency</strong> seconds<br>
                        4. Send batch when queue empty OR hit <strong>Max Wait</strong> time
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Initial Delay</label>
                        <input type="number" id="config-initial-delay" value="7" min="1" max="30" 
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4; font-size: 16px;">
                        <small style="color: #666; font-size: 11px;">Minutes to wait after download (Plex indexing time)</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Extension Delay</label>
                        <input type="number" id="config-extension-delay" value="3" min="1" max="10" 
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4; font-size: 16px;">
                        <small style="color: #666; font-size: 11px;">Minutes to extend when more episodes detected</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Max Wait Time</label>
                        <input type="number" id="config-max-wait" value="20" min="5" max="60" 
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4; font-size: 16px;">
                        <small style="color: #666; font-size: 11px;">Maximum minutes to wait before sending batch</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Check Frequency</label>
                        <input type="number" id="config-check-frequency" value="60" min="30" max="300" 
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4; font-size: 16px;">
                        <small style="color: #666; font-size: 11px;">Seconds between queue checks</small>
                    </div>
                </div>
            </div>

            <!-- Email Settings Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">üìß Email Settings</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px;">Configure your SMTP server and email sender details.</p>
                
                <!-- SMTP Server -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #fff; margin-bottom: 15px; font-size: 14px;">üåê SMTP Server</h4>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Host / IP Address</label>
                            <input type="text" id="config-smtp-host" placeholder="smtp.gmail.com or 192.168.1.100" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Port</label>
                            <input type="number" id="config-smtp-port" placeholder="587" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <small style="color: #666; font-size: 10px;">587 (TLS) or 465 (SSL)</small>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Username</label>
                        <input type="text" id="config-smtp-user" placeholder="user@gmail.com" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Password / API Key</label>
                        <input type="password" id="config-smtp-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                </div>
                
                <!-- Email Sender -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #fff; margin-bottom: 15px; font-size: 14px;">‚úâÔ∏è Sender Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Display Name</label>
                            <input type="text" id="config-smtp-from-name" placeholder="BingeAlert" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">From Email Address</label>
                            <input type="email" id="config-smtp-from-email" placeholder="noreply@example.com" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Monitoring Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">üîç Quality & Release Monitoring</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    Automatically notify users when their requested content isn't available yet due to release dates or quality profile settings.
                </p>
                
                <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                    <strong style="color: #8a2be2;">How it works:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        1Ô∏è‚É£ Request approved ‚Üí Quality check after 10 seconds<br>
                        2Ô∏è‚É£ If no quality found ‚Üí "Waiting" email queued with delay<br>
                        3Ô∏è‚É£ Radarr/Sonarr <strong>Grab</strong> webhook ‚Üí Cancels waiting email<br>
                        4Ô∏è‚É£ Download completes ‚Üí Sends "Available" email<br>
                        <br>
                        üìÖ <strong>Coming Soon:</strong> Movies/shows not yet released (sends premiere date immediately)<br>
                        ‚è≥ <strong>Quality Waiting:</strong> Content available but not in requested quality (delayed, can be cancelled)
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: start; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="config-quality-monitor-enabled" checked>
                            <span class="slider"></span>
                        </label>
                        <label for="config-quality-monitor-enabled" style="color: #e4e4e4; font-size: 14px; cursor: pointer;">
                            Enable Quality Monitoring
                        </label>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #999; font-size: 12px;">Periodic Check Interval</label>
                            <select id="config-quality-monitor-interval" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                                <option value="6">Every 6 hours</option>
                                <option value="12">Every 12 hours</option>
                                <option value="24" selected>Every 24 hours</option>
                                <option value="48">Every 48 hours</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">Background check for all pending requests</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #999; font-size: 12px;">Quality Waiting Delay</label>
                            <select id="config-quality-waiting-delay" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                                <option value="300" selected>5 minutes</option>
                                <option value="600">10 minutes</option>
                                <option value="900">15 minutes</option>
                                <option value="1800">30 minutes</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">Delay before sending (allows cancellation)</small>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(229, 160, 13, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #e5a00d;">
                    <strong style="color: #e5a00d;">üì° Required Webhooks:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        For this feature to work properly, configure webhooks in Sonarr/Radarr:<br>
                        ‚Ä¢ <strong>On Grab</strong> - Cancels quality waiting when download starts<br>
                        ‚Ä¢ <strong>On Import</strong> - Sends available notification when download completes
                    </span>
                </div>
            </div>

            <!-- Issue Auto-fix Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #f44336;">üö® Issue Auto-fix</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    When users report issues in Seerr (bad audio, wrong subtitles, corrupted video, etc.), the portal can automatically blacklist the current file and trigger a new search in Sonarr/Radarr.
                </p>
                
                <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f44336;">
                    <strong style="color: #f44336;">How it works:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        1Ô∏è‚É£ User reports issue in Seerr ‚Üí Webhook fires<br>
                        2Ô∏è‚É£ Portal logs the issue and takes action based on mode<br>
                        3Ô∏è‚É£ Current file is blacklisted + new search triggered<br>
                        4Ô∏è‚É£ When new file downloads ‚Üí User gets "Issue Resolved" email<br>
                        <br>
                        If the issue persists, the user can report again in Seerr.
                    </span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #999; font-size: 12px;">Auto-fix Mode</label>
                    <select id="config-issue-autofix-mode" 
                            style="width: 100%; max-width: 400px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        <option value="manual">‚è∏Ô∏è Manual ‚Äî Admin reviews issues in dashboard first</option>
                        <option value="auto">ü§ñ Auto ‚Äî Blacklist & re-search automatically (no admin email)</option>
                        <option value="auto_notify">ü§ñüìß Auto + Notify ‚Äî Auto-fix and email admin about it</option>
                    </select>
                    <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">In Manual mode, use the Issues tab to review and trigger fixes.</small>
                </div>
                
                <div style="background: rgba(229, 160, 13, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #e5a00d;">
                    <strong style="color: #e5a00d;">üì° Required Seerr Webhook:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        Enable <strong>Issue Created</strong> webhook event in Seerr ‚Üí Settings ‚Üí Notifications ‚Üí Webhook
                    </span>
                </div>
            </div>

            <!-- Authentication & Security Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">üîÑ Reconciliation & Issue Cleanup</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    The reconciliation worker periodically checks for missed webhooks, orphaned episodes, and stale issues that need cleanup.
                </p>
                
                <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
                    <strong style="color: #4CAF50;">How it works:</strong><br>
                    <span style="color: #999; font-size: 13px;">
                        1Ô∏è‚É£ <strong>Missed Episodes</strong> ‚Äî Scans Sonarr/Radarr for downloaded content that never triggered a webhook<br>
                        2Ô∏è‚É£ <strong>Orphaned Tracking</strong> ‚Äî Finds tracked episodes with no matching notification and creates one<br>
                        3Ô∏è‚É£ <strong>Stale Issues (Fixing)</strong> ‚Äî Issues stuck in "fixing" where the import webhook never came back<br>
                        4Ô∏è‚É£ <strong>Stale Issues (Reported)</strong> ‚Äî Issues that were never auto-fixed and remain in "reported"<br>
                        5Ô∏è‚É£ <strong>Abandoned Issues</strong> ‚Äî Issues stuck for too long with no resolution ‚Üí marked as failed
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Check Interval</label>
                        <select id="config-recon-interval" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <option value="1">Every 1 hour</option>
                            <option value="2" selected>Every 2 hours</option>
                            <option value="4">Every 4 hours</option>
                            <option value="6">Every 6 hours</option>
                            <option value="12">Every 12 hours</option>
                        </select>
                        <small style="color: #666; font-size: 11px;">How often to scan for missed webhooks & stale issues</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Fixing Issue Cutoff</label>
                        <select id="config-recon-fixing-cutoff" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <option value="1" selected>1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="4">4 hours</option>
                            <option value="6">6 hours</option>
                        </select>
                        <small style="color: #666; font-size: 11px;">How long to wait before checking "fixing" issues for resolution</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Reported Issue Cutoff</label>
                        <select id="config-recon-reported-cutoff" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <option value="12">12 hours</option>
                            <option value="24" selected>24 hours</option>
                            <option value="48">48 hours</option>
                            <option value="72">72 hours</option>
                        </select>
                        <small style="color: #666; font-size: 11px;">How long before checking "reported" issues that were never fixed</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #e5a00d; font-size: 13px; font-weight: bold;">Abandon After</label>
                        <select id="config-recon-abandon-days" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <option value="3">3 days</option>
                            <option value="5">5 days</option>
                            <option value="7" selected>7 days</option>
                            <option value="14">14 days</option>
                            <option value="30">30 days</option>
                        </select>
                        <small style="color: #666; font-size: 11px;">Mark issues as failed if no resolution after this long</small>
                    </div>
                </div>
            </div>

            <!-- Authentication & Security Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">üîê Authentication & Security</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    Require a password for external access. Local network connections bypass the login page automatically.
                </p>
                
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: start; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="config-auth-enabled">
                            <span class="slider"></span>
                        </label>
                        <label for="config-auth-enabled" style="color: #e4e4e4; font-size: 14px; cursor: pointer;">
                            Enable Authentication
                        </label>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Admin Password</label>
                            <input type="password" id="config-auth-password" placeholder="Enter new password (leave blank to keep current)" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                            <small style="color: #666; font-size: 11px;" id="config-auth-password-hint">No password set</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Session Timeout</label>
                            <select id="config-auth-session-timeout" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                                <option value="1">1 hour</option>
                                <option value="4">4 hours</option>
                                <option value="12">12 hours</option>
                                <option value="24" selected>24 hours</option>
                                <option value="72">3 days</option>
                                <option value="168">7 days</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">How long before re-login required</small>
                        </div>
                    </div>
                </div>
                
                <!-- Local Network -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #fff; margin-bottom: 10px; font-size: 14px;">üè† Local Network Bypass</h4>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Network CIDR (comma-separated for multiple)</label>
                        <input type="text" id="config-auth-local-cidr" placeholder="192.168.1.0/24, 10.0.0.0/8" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        <small style="color: #666; font-size: 11px;">Connections from these IP ranges skip login. Example: 192.168.1.0/24 covers 192.168.1.1‚Äì192.168.1.254</small>
                    </div>
                </div>
                
                <!-- Cloudflare Turnstile -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <label class="switch">
                            <input type="checkbox" id="config-turnstile-enabled">
                            <span class="slider"></span>
                        </label>
                        <h4 style="color: #fff; margin: 0; font-size: 14px;">‚òÅÔ∏è Cloudflare Turnstile</h4>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-bottom: 12px;">
                        Adds a bot verification challenge to the login page. Get free keys at 
                        <a href="https://dash.cloudflare.com/?to=/:account/turnstile" target="_blank" style="color: #e5a00d;">Cloudflare Turnstile Dashboard</a>.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Site Key</label>
                            <input type="text" id="config-turnstile-site-key" placeholder="0x4AAAAAAA..." 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Secret Key</label>
                            <input type="password" id="config-turnstile-secret-key" placeholder="0x4AAAAAAA..." 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Webhook & Application Security Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: #e5a00d;">üõ°Ô∏è Webhook & Application Security</h3>
                <p style="color: #999; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
                    Restrict which IPs can send webhooks to BingeAlert and control application-level security settings. Changes require a container restart.
                </p>
                
                <!-- Webhook IP Allowlist -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #fff; margin-bottom: 10px; font-size: 14px;">üåê Webhook IP Allowlist</h4>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Allowed IPs (comma-separated IPs or CIDRs)</label>
                        <input type="text" id="config-webhook-allowed-ips" placeholder="192.168.1.100, 10.0.0.0/24" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        <small style="color: #666; font-size: 11px;">Only these IPs can send webhooks from Sonarr/Radarr/Seerr. Leave blank to allow all IPs (not recommended for external access).</small>
                    </div>
                </div>
                
                <!-- Environment Mode -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #fff; margin-bottom: 10px; font-size: 14px;">‚öôÔ∏è Environment Mode</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Mode</label>
                            <select id="config-environment" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                                <option value="production">Production (recommended)</option>
                                <option value="development">Development</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">Production disables API docs (/docs, /redoc). Development enables them for debugging.</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">App Secret Key</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="password" id="config-app-secret-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                       style="flex: 1; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;" readonly>
                                <button onclick="generateSecretKey()" class="secondary" style="white-space: nowrap; padding: 8px 12px; font-size: 12px;" title="Generate a strong random key">üé≤ Generate</button>
                            </div>
                            <small style="color: #666; font-size: 11px;" id="config-secret-key-hint">Used to sign session cookies. Click Generate for a strong random key.</small>
                        </div>
                    </div>
                </div>

                <!-- Security Status -->
                <div id="security-status" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                    <h4 style="color: #fff; margin-bottom: 10px; font-size: 14px;">üìã Security Status</h4>
                    <div id="security-checklist" style="font-size: 13px; line-height: 2;">
                        <!-- Populated by loadConfig -->
                    </div>
                </div>
            </div>

            <!-- Services Section -->
            <h3 style="margin-bottom: 15px; color: #e5a00d;">üîó Connected Services</h3>
            <p style="color: #999; margin-bottom: 20px; font-size: 13px;">Configure connections to your media management services.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Overseerr/Jellyseerr -->
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 10px; color: #e5a00d;">üé¨ Overseerr / Jellyseerr</h3>
                    <p style="color: #666; font-size: 11px; margin-bottom: 15px;">Request management system</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">IP Address / Hostname</label>
                            <input type="text" id="config-jellyseerr-host" placeholder="192.168.1.100 or jellyseerr" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Port</label>
                            <input type="number" id="config-jellyseerr-port" placeholder="5055" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">API Key</label>
                        <input type="password" id="config-jellyseerr-api" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                </div>

                <!-- Sonarr -->
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 10px; color: #e5a00d;">üì∫ Sonarr</h3>
                    <p style="color: #666; font-size: 11px; margin-bottom: 15px;">TV show management</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">IP Address / Hostname</label>
                            <input type="text" id="config-sonarr-host" placeholder="192.168.1.100 or sonarr" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Port</label>
                            <input type="number" id="config-sonarr-port" placeholder="8989" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">API Key</label>
                        <input type="password" id="config-sonarr-api" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                </div>

                <!-- Radarr -->
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 10px; color: #e5a00d;">üé• Radarr</h3>
                    <p style="color: #666; font-size: 11px; margin-bottom: 15px;">Movie management</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">IP Address / Hostname</label>
                            <input type="text" id="config-radarr-host" placeholder="192.168.1.100 or radarr" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Port</label>
                            <input type="number" id="config-radarr-port" placeholder="7878" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">API Key</label>
                        <input type="password" id="config-radarr-api" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                </div>

                <!-- Plex -->
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 10px; color: #e5a00d;">üçø Plex Media Server</h3>
                    <p style="color: #666; font-size: 11px; margin-bottom: 15px;">Media verification (optional)</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">IP Address / Hostname</label>
                            <input type="text" id="config-plex-host" placeholder="192.168.1.100 or plex" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">Port</label>
                            <input type="number" id="config-plex-port" placeholder="32400" 
                                   style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 12px;">X-Plex-Token</label>
                        <input type="password" id="config-plex-token" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                               style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    </div>
                </div>
            </div>

            <div style="text-align: right;">
                <button onclick="loadConfig()" class="secondary" style="margin-right: 10px;">‚Üª Reload</button>
                <button onclick="restartContainer()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px;">üîÑ Restart</button>
                <button onclick="saveConfig()" id="saveConfigBtn">üíæ Save</button>
            </div>
        </div>

        <div id="logsTab" class="tab-content">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <button onclick="loadLogs()" id="refreshLogsBtn" class="secondary">üîÑ Refresh</button>
                <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="secondary">‚ñ∂Ô∏è Auto-Refresh</button>
                <select id="logLines" onchange="loadLogs()" style="padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    <option value="50">Last 50 lines</option>
                    <option value="100" selected>Last 100 lines</option>
                    <option value="200">Last 200 lines</option>
                    <option value="500">Last 500 lines</option>
                </select>
                <input type="text" id="logSearch" placeholder="Filter logs..." oninput="filterLogs()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
            </div>
            
            <div style="background: #000; padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5;" id="logsContainer">
                <div style="color: #999; text-align: center; padding: 40px;">
                    Click "Refresh" to load logs
                </div>
            </div>
        </div>
    </div>


    <!-- Test Email Modal -->
    <div id="testEmailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1a1a2e; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; border: 1px solid rgba(255,255,255,0.1);">
            <h2 style="margin-bottom: 20px; color: #e5a00d;">Send Test Email</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Email Address</label>
                <input type="email" id="testEmailAddress" placeholder="user@example.com" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Notification Type</label>
                <select id="testEmailType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                    <option value="episode">TV Episode (Breaking Bad)</option>
                    <option value="movie">Movie (The Shawshank Redemption)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeTestEmailModal()" class="secondary">Cancel</button>
                <button onclick="sendTestEmail()" id="sendTestBtn">Send Test Email</button>
            </div>
        </div>
    </div>

    <!-- Shared Users Modal -->
    <div id="sharedUsersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1a1a2e; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 10px; color: #e5a00d;">üë• Manage Shared Users</h2>
            <p style="color: #999; margin-bottom: 20px; font-size: 14px;" id="sharedUsersTitle"></p>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #e5a00d; font-size: 16px; margin-bottom: 10px;">Current Users</h3>
                <div id="sharedUsersList" style="max-height: 200px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #999;">Loading...</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #e5a00d; font-size: 16px; margin-bottom: 10px;">Add User</h3>
                <div style="display: flex; gap: 10px;">
                    <div id="addUserSelectWrap" class="custom-select-wrap" style="flex: 1;">
                        <div class="custom-select-display" id="addUserDisplay" onclick="toggleCustomSelect('addUser', event)">Select a user...</div>
                        <div class="custom-select-options" id="addUserOptions"></div>
                        <input type="hidden" id="addUserSelect" value="">
                    </div>
                    <button id="addUserBtn" onclick="addSharedUser()" style="padding: 10px 20px; background: #e5a00d; color: white; border: none; border-radius: 8px; cursor: pointer;">Add</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSharedUsersModal()" class="secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let allRequests = [];
        let allNotifications = [];
        let allUpcoming = [];
        let allIssues = [];
        let upcomingViewMode = 'grouped'; // 'grouped' or 'list'
        
        // Sorting state
        let sortState = {
            users: { column: 'created_at', direction: 'desc' },
            requests: { column: 'created_at', direction: 'desc' },
            notifications: { column: 'created_at', direction: 'desc' },
            upcoming: { column: 'air_date', direction: 'asc' }  // Upcoming should be chronological (soonest first)
        };

        // API Base URL
        const API_BASE = '';
        
        // Global 401 handler - redirect to login on auth failure
        const _origFetch = window.fetch;
        window.fetch = async function(...args) {
            const resp = await _origFetch.apply(this, args);
            if (resp.status === 401 && !args[0]?.toString().includes('/auth/')) {
                window.location.href = '/login';
            }
            return resp;
        };


        // Load initial data
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`);
                const data = await response.json();
                
                console.log('Stats loaded:', data);
                
                document.getElementById('totalUsers').textContent = data.users || 0;
                document.getElementById('totalRequests').textContent = data.requests.total || 0;
                document.getElementById('trackingRequests').textContent = data.requests.tracking || 0;
                document.getElementById('episodesTracked').textContent = data.episodes_tracked || 0;
                document.getElementById('notificationsSent').textContent = data.notifications.sent || 0;
                document.getElementById('notificationsPending').textContent = data.notifications.pending || 0;
                
                console.log('Pending notifications:', data.notifications.pending);
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users?limit=1000`);
                const data = await response.json();
                allUsers = data.users || [];
                // Sort by default
                allUsers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                renderUsers(allUsers);
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load users</td></tr>';
            }
        }

        async function loadRequests() {
            try {
                const response = await fetch(`${API_BASE}/admin/requests?limit=1000`);
                const data = await response.json();
                allRequests = data.requests || [];
                // Sort by default
                allRequests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                renderRequests(allRequests);
            } catch (error) {
                console.error('Failed to load requests:', error);
                document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="7" class="empty-state">Failed to load requests</td></tr>';
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/admin/notifications?limit=1000`);
                const data = await response.json();
                allNotifications = data.notifications || [];
                // Sort by default - newest first
                allNotifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                renderNotifications(allNotifications);
            } catch (error) {
                console.error('Failed to load notifications:', error);
                document.getElementById('notificationsTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">Failed to load notifications</td></tr>';
            }
        }

        async function loadUpcoming() {
            try {
                const days = document.getElementById('upcomingDays')?.value || 30;
                const response = await fetch(`${API_BASE}/admin/upcoming-episodes?days=${days}`);
                const data = await response.json();
                allUpcoming = data.upcoming || [];
                // Sort by air date - soonest first
                allUpcoming.sort((a, b) => new Date(a.air_date) - new Date(b.air_date));
                
                
                // Populate user filter
                const userFilter = document.getElementById('upcomingUserFilter');
                const uniqueUsers = [...new Set(allUpcoming.map(ep => ep.user_name).filter(Boolean))].sort();
                const currentSelection = userFilter.value;
                userFilter.innerHTML = '<option value="all">All Users</option>' + 
                    uniqueUsers.map(user => `<option value="${user}">${user}</option>`).join('');
                userFilter.value = currentSelection;
                
                // Apply filter
                filterUpcoming();
            } catch (error) {
                console.error('Failed to load upcoming episodes:', error);
                document.getElementById('upcomingGroupedContent').innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Failed to load upcoming episodes</div>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div>No users found</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.jellyseerr_id}</td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderRequests(requests) {
            const tbody = document.getElementById('requestsTableBody');
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div>No requests found</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = requests.map(req => `
                <tr>
                    <td>${req.id}</td>
                    <td>${req.user_email}</td>
                    <td><span class="badge ${req.media_type}">${req.media_type.toUpperCase()}</span></td>
                    <td>${req.title}</td>
                    <td><span class="badge ${req.status}">${req.status}</span></td>
                    <td>${new Date(req.created_at).toLocaleString()}</td>
                    <td>
                        <button class="action-btn" onclick="manageSharedUsers(${req.id}, '${req.title.replace(/'/g, "\\'")}')">üë• Users</button>
                        ${req.media_type === 'tv' ? `<button class="action-btn" onclick="importEpisodes(${req.id})">üì• Import</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderNotifications(notifications) {
            const tbody = document.getElementById('notificationsTableBody');
            if (notifications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div>No notifications found</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = notifications.map(notif => {
                // For pending notifications, show when they'll be sent
                let sentAtDisplay = '-';
                if (notif.sent && notif.sent_at) {
                    sentAtDisplay = new Date(notif.sent_at).toLocaleString();
                } else if (!notif.sent && notif.send_after) {
                    const sendTime = new Date(notif.send_after);
                    sentAtDisplay = `<span style="color: #e5a00d;">‚è∞ ${sendTime.toLocaleString()}</span>`;
                }
                
                return `
                <tr>
                    <td>${notif.id}</td>
                    <td>${notif.user_email}</td>
                    <td>${notif.type}</td>
                    <td>${notif.subject}</td>
                    <td><span class="badge ${notif.sent ? 'sent' : 'pending-email'}">${notif.sent ? 'Sent' : 'Pending'}</span></td>
                    <td>${new Date(notif.created_at).toLocaleString()}</td>
                    <td>${sentAtDisplay}</td>
                    <td>
                        <button class="action-btn" onclick="resendNotification(${notif.id})">üîÅ ${notif.sent ? 'Resend' : 'Send Now'}</button>
                    </td>
                </tr>
            `}).join('');
        }

        function toggleUpcomingView() {
            const btn = document.getElementById('viewToggleBtn');
            const groupedView = document.getElementById('upcomingGroupedView');
            const tableView = document.getElementById('upcomingTableView');
            
            if (upcomingViewMode === 'grouped') {
                upcomingViewMode = 'list';
                groupedView.style.display = 'none';
                tableView.style.display = 'block';
                btn.textContent = 'üìä Grouped View';
                filterUpcoming();
            } else {
                upcomingViewMode = 'grouped';
                groupedView.style.display = 'block';
                tableView.style.display = 'none';
                btn.textContent = 'üìã List View';
                filterUpcoming();
            }
        }

        function renderUpcomingGrouped(upcoming) {
            const container = document.getElementById('upcomingGroupedContent');
            
            if (upcoming.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div>No upcoming episodes found for requested shows</div></div>';
                return;
            }
            
            // Deduplicate episodes (same episode shared with multiple users)
            const episodeMap = {};
            upcoming.forEach(ep => {
                const key = `${ep.series_id}-${ep.season_number}-${ep.episode_number}`;
                if (!episodeMap[key]) {
                    episodeMap[key] = {...ep, users: [ep.user_name].filter(Boolean)};
                } else if (ep.user_name && !episodeMap[key].users.includes(ep.user_name)) {
                    episodeMap[key].users.push(ep.user_name);
                }
            });
            const uniqueEpisodes = Object.values(episodeMap);
            
            // Group by series
            const seriesMap = {};
            uniqueEpisodes.forEach(ep => {
                if (!seriesMap[ep.series_title]) {
                    seriesMap[ep.series_title] = [];
                }
                seriesMap[ep.series_title].push(ep);
            });
            
            // Sort series alphabetically
            const seriesNames = Object.keys(seriesMap).sort();
            
            // Render grouped view
            container.innerHTML = seriesNames.map(seriesName => {
                const episodes = seriesMap[seriesName];
                const downloadedCount = episodes.filter(ep => ep.has_file).length;
                const notifiedCount = episodes.filter(ep => ep.already_notified).length;
                
                const episodesHtml = episodes.map(ep => {
                    const airDate = new Date(ep.air_date);
                    const isToday = airDate.toDateString() === new Date().toDateString();
                    const isPast = airDate < new Date();
                    const showNotifyButton = ep.has_file && !ep.already_notified;
                    const usersList = ep.users && ep.users.length > 0 ? ep.users.join(', ') : '';
                    
                    return `
                        <div style="background: rgba(0,0,0,${isToday ? '0.4' : '0.2'}); padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; gap: 15px; ${isToday ? 'border-left: 3px solid #e5a00d;' : ''}">
                            <div style="min-width: 80px; font-weight: bold; color: #e5a00d;">
                                S${String(ep.season_number).padStart(2, '0')}E${String(ep.episode_number).padStart(2, '0')}
                            </div>
                            <div style="flex: 1;">
                                <div style="color: #e4e4e4; margin-bottom: 3px;">${ep.episode_title || 'TBA'}</div>
                                <div style="font-size: 12px; color: #999;">
                                    ${airDate.toLocaleDateString()} ${airDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    ${usersList ? ` ‚Ä¢ ${usersList}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="badge ${ep.has_file ? 'available' : 'pending'}" style="font-size: 11px;">
                                    ${ep.has_file ? '‚úì Downloaded' : (isPast ? 'Waiting' : 'Not Aired')}
                                </span>
                                <span class="badge ${ep.already_notified ? 'sent' : 'pending-email'}" style="font-size: 11px;">
                                    ${ep.already_notified ? 'Notified' : 'Will Notify'}
                                </span>
                                <button class="action-btn" onclick="manageSharedUsers(${ep.request_id}, '${ep.series_title.replace(/'/g, "\\'")} - S${String(ep.season_number).padStart(2, '0')}E${String(ep.episode_number).padStart(2, '0')}')" style="padding: 6px 12px; font-size: 12px;">
                                    üë• Users
                                </button>
                                ${showNotifyButton ? `
                                    <button class="action-btn" onclick="notifyEpisodeNow(${ep.request_id}, ${ep.series_id}, ${ep.season_number}, ${ep.episode_number})" style="padding: 6px 12px; font-size: 12px;">
                                        üìß Notify
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 20px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, rgba(229, 160, 13, 0.2) 0%, rgba(229, 160, 13, 0.1) 100%); padding: 15px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;" onclick="toggleSeriesExpand('${seriesName.replace(/'/g, "\\'")}')">
                            <div>
                                <h3 style="margin: 0; color: #e5a00d; font-size: 18px;">üì∫ ${seriesName}</h3>
                                <div style="font-size: 13px; color: #999; margin-top: 5px;">
                                    ${episodes.length} episode${episodes.length !== 1 ? 's' : ''} ‚Ä¢ 
                                    ${downloadedCount} downloaded ‚Ä¢ 
                                    ${notifiedCount} notified
                                </div>
                            </div>
                            <div id="expand-icon-${seriesName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 24px; color: #e5a00d; transition: transform 0.3s;">‚ñº</div>
                        </div>
                        <div id="series-${seriesName.replace(/[^a-zA-Z0-9]/g, '_')}" style="padding: 15px 20px; display: block;">
                            ${episodesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSeriesExpand(seriesName) {
            const safeId = seriesName.replace(/[^a-zA-Z0-9]/g, '_');
            const content = document.getElementById(`series-${safeId}`);
            const icon = document.getElementById(`expand-icon-${safeId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function renderUpcoming(upcoming) {
            const tbody = document.getElementById('upcomingTableBody');
            if (upcoming.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div>No upcoming episodes found for requested shows</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = upcoming.map(ep => {
                const airDate = new Date(ep.air_date);
                const isToday = airDate.toDateString() === new Date().toDateString();
                const isPast = airDate < new Date();
                
                // Show "Notify Now" button if downloaded and not already notified
                const showNotifyButton = ep.has_file && !ep.already_notified;
                
                return `
                <tr style="${isToday ? 'background: rgba(229, 160, 13, 0.1);' : ''}">
                    <td>${ep.series_title}</td>
                    <td>S${String(ep.season_number).padStart(2, '0')}E${String(ep.episode_number).padStart(2, '0')}</td>
                    <td>${ep.episode_title || 'TBA'}</td>
                    <td>${airDate.toLocaleDateString()} ${airDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td><span class="badge ${ep.has_file ? 'available' : 'pending'}">${ep.has_file ? '‚úì Downloaded' : isPast ? 'Waiting' : 'Not Aired'}</span></td>
                    <td>${ep.user_name} (${ep.user_email})</td>
                    <td><span class="badge ${ep.already_notified ? 'sent' : 'pending-email'}">${ep.already_notified ? 'Notified' : 'Will Notify'}</span></td>
                    <td>
                        <button class="action-btn" onclick="manageSharedUsers(${ep.request_id}, '${ep.series_title.replace(/'/g, "\\'")} - S${String(ep.season_number).padStart(2, '0')}E${String(ep.episode_number).padStart(2, '0')}')">üë• Users</button>
                        ${showNotifyButton ? `<button class="action-btn" onclick="notifyEpisodeNow(${ep.request_id}, ${ep.series_id}, ${ep.season_number}, ${ep.episode_number})">üìß Notify Now</button>` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.username.toLowerCase().includes(search) || 
                u.email.toLowerCase().includes(search)
            );
            renderUsers(filtered);
        }

        function filterRequests() {
            applyRequestFilters();
        }

        function filterNotifications() {
            applyNotificationFilters();
        }

        function filterUpcoming() {
            const search = document.getElementById('upcomingSearch').value.toLowerCase();
            const userFilter = document.getElementById('upcomingUserFilter').value;
            
            let filtered = allUpcoming.filter(ep => {
                const matchesSearch = ep.series_title.toLowerCase().includes(search) || 
                                     (ep.episode_title && ep.episode_title.toLowerCase().includes(search)) ||
                                     (ep.user_email && ep.user_email.toLowerCase().includes(search));
                const matchesUser = userFilter === 'all' || ep.user_name === userFilter;
                return matchesSearch && matchesUser;
            });
            
            // Render based on current view mode
            if (upcomingViewMode === 'grouped') {
                renderUpcomingGrouped(filtered);
            } else {
                renderUpcoming(filtered);
            }
        }

        // Type filter state
        let currentRequestFilter = 'all';
        let currentNotificationFilter = 'all';

        function filterRequestsByType(type) {
            currentRequestFilter = type;
            
            // Update button styles
            document.getElementById('requestFilterAll').style.background = type === 'all' ? '#e5a00d' : 'transparent';
            document.getElementById('requestFilterTV').style.background = type === 'tv' ? '#e5a00d' : 'transparent';
            document.getElementById('requestFilterMovie').style.background = type === 'movie' ? '#e5a00d' : 'transparent';
            
            // Apply both search and type filters
            applyRequestFilters();
        }

        function filterNotificationsByType(type) {
            currentNotificationFilter = type;
            
            // Update button styles
            document.getElementById('notificationFilterAll').style.background = type === 'all' ? '#e5a00d' : 'transparent';
            document.getElementById('notificationFilterTV').style.background = type === 'episode' ? '#e5a00d' : 'transparent';
            document.getElementById('notificationFilterMovie').style.background = type === 'movie' ? '#e5a00d' : 'transparent';
            
            // Apply both search and type filters
            applyNotificationFilters();
        }

        function applyRequestFilters() {
            const search = document.getElementById('requestSearch').value.toLowerCase();
            let filtered = allRequests;
            
            // Apply type filter
            if (currentRequestFilter !== 'all') {
                filtered = filtered.filter(r => r.media_type === currentRequestFilter);
            }
            
            // Apply search filter
            if (search) {
                filtered = filtered.filter(r => 
                    r.title.toLowerCase().includes(search) || 
                    r.user_email.toLowerCase().includes(search)
                );
            }
            
            renderRequests(filtered);
        }

        function applyNotificationFilters() {
            const search = document.getElementById('notificationSearch').value.toLowerCase();
            let filtered = allNotifications;
            
            // Apply type filter
            if (currentNotificationFilter !== 'all') {
                filtered = filtered.filter(n => n.type === currentNotificationFilter);
            }
            
            // Apply search filter
            if (search) {
                filtered = filtered.filter(n => 
                    n.subject.toLowerCase().includes(search) || 
                    n.user_email.toLowerCase().includes(search)
                );
            }
            
            renderNotifications(filtered);
        }

        // ===== Issues Management =====
        
        async function loadIssues() {
            try {
                const response = await fetch(`${API_BASE}/admin/issues`);
                allIssues = await response.json();
                renderIssues(allIssues);
            } catch (error) {
                console.error('Failed to load issues:', error);
                document.getElementById('issuesTableBody').innerHTML = 
                    '<tr><td colspan="8" style="color: #f44336;">Failed to load issues</td></tr>';
            }
        }
        
        function renderIssues(issues) {
            const tbody = document.getElementById('issuesTableBody');
            
            if (!issues || issues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="color: #666; text-align: center; padding: 40px;">No issues reported yet. Issues reported in Seerr will appear here.</td></tr>';
                return;
            }
            
            tbody.innerHTML = issues.map(issue => {
                const statusColors = {
                    'reported': '#e5a00d',
                    'fixing': '#2196f3',
                    'resolved': '#4caf50',
                    'failed': '#f44336'
                };
                const statusIcons = {
                    'reported': 'üîî',
                    'fixing': 'üîß',
                    'resolved': '‚úÖ',
                    'failed': '‚ùå'
                };
                const issueTypeIcons = {
                    'video': 'üé¨',
                    'audio': 'üîä',
                    'subtitle': 'üí¨',
                    'other': '‚ùì'
                };
                
                const statusColor = statusColors[issue.status] || '#999';
                const statusIcon = statusIcons[issue.status] || '‚ùì';
                const typeIcon = issueTypeIcons[issue.issue_type] || '‚ùì';
                const mediaIcon = issue.media_type === 'movie' ? 'üé¨' : 'üì∫';
                
                const date = issue.created_at ? new Date(issue.created_at).toLocaleDateString() : '';
                const message = issue.issue_message ? 
                    (issue.issue_message.length > 50 ? issue.issue_message.substring(0, 50) + '...' : issue.issue_message) : 
                    '<span style="color: #666;">‚Äî</span>';
                
                let actions = '';
                if (issue.status === 'reported' || issue.status === 'failed') {
                    actions += `<button onclick="fixIssue(${issue.id})" style="padding: 4px 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 4px;" title="Blacklist current file and search for new one">üîß Fix</button>`;
                    actions += `<button onclick="resolveIssue(${issue.id})" style="padding: 4px 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 4px;" title="Mark as resolved without re-downloading">‚úÖ</button>`;
                }
                if (issue.status === 'fixing') {
                    actions += `<span style="color: #2196f3; font-size: 12px;">‚è≥ In progress...</span>`;
                }
                actions += `<button onclick="deleteIssue(${issue.id})" style="padding: 4px 10px; background: rgba(244,67,54,0.2); color: #f44336; border: 1px solid rgba(244,67,54,0.3); border-radius: 4px; cursor: pointer; font-size: 12px;" title="Delete issue">üóëÔ∏è</button>`;
                
                return `
                    <tr>
                        <td>${mediaIcon} ${issue.title}</td>
                        <td>${issue.media_type}</td>
                        <td>${typeIcon} ${issue.issue_type || 'other'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${issue.issue_message || ''}">${message}</td>
                        <td>${issue.reported_by || 'Unknown'}</td>
                        <td><span style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${issue.status}</span>
                            ${issue.error_message ? `<br><small style="color: #f44336;">${issue.error_message}</small>` : ''}
                        </td>
                        <td>${date}</td>
                        <td style="white-space: nowrap;">${actions}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterIssues() {
            const search = document.getElementById('issueSearch').value.toLowerCase();
            const statusFilter = document.getElementById('issueStatusFilter').value;
            
            const filtered = allIssues.filter(issue => {
                const matchesSearch = !search || 
                    issue.title.toLowerCase().includes(search) || 
                    (issue.issue_message || '').toLowerCase().includes(search) ||
                    (issue.reported_by || '').toLowerCase().includes(search);
                const matchesStatus = statusFilter === 'all' || issue.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            renderIssues(filtered);
        }
        
        async function fixIssue(issueId) {
            if (!confirm('Blacklist the current file and trigger a new search?\n\nThis will remove the existing file and search for a new one from a different source.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/issues/${issueId}/fix`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError(result.message);
                }
                
                await loadIssues();
            } catch (error) {
                showError('Failed to fix issue: ' + error.message);
            }
        }
        
        async function resolveIssue(issueId) {
            if (!confirm('Mark this issue as resolved without re-downloading?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/issues/${issueId}/resolve`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError(result.message);
                }
                
                await loadIssues();
            } catch (error) {
                showError('Failed to resolve issue: ' + error.message);
            }
        }
        
        async function deleteIssue(issueId) {
            if (!confirm('Delete this issue record?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/issues/${issueId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError(result.message);
                }
                
                await loadIssues();
            } catch (error) {
                showError('Failed to delete issue: ' + error.message);
            }
        }

        function switchTab(tabName, evt) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const targetTab = document.querySelector(`.tab[onclick*="'${tabName}'"]`);
            if (targetTab) targetTab.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load data if not loaded
            if (tabName === 'users' && allUsers.length === 0) loadUsers();
            if (tabName === 'requests' && allRequests.length === 0) loadRequests();
            if (tabName === 'notifications') {
                // Always show ALL notifications when clicking the tab (reset filter)
                if (allNotifications.length === 0) {
                    loadNotifications();
                } else {
                    renderNotifications(allNotifications);
                }
            }
            if (tabName === 'upcoming' && allUpcoming.length === 0) loadUpcoming();
            if (tabName === 'issues' && allIssues.length === 0) loadIssues();
            if (tabName === 'backup') loadBackups();
            if (tabName === 'settings') loadConfig();
            if (tabName === 'logs' && !allLogs) loadLogs();
        }

        async function syncUsers() {
            if (!confirm('Sync users from Jellyseerr?\n\nThis is safe and won\'t affect requests.')) {
                return;
            }
            
            const btn = document.getElementById('syncUsersBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/sync/users`, { method: 'POST' });
                const data = await response.json();
                showSuccess('Users synced successfully!');
                await refreshData();
            } catch (error) {
                showError('Failed to sync users: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Users';
            }
        }

        async function syncRequests() {
            if (!confirm('‚ö†Ô∏è WARNING: This will pull ALL requests from Jellyseerr (including old/completed ones).\n\nSince you\'re using webhooks, you probably don\'t need this.\n\nContinue anyway?')) {
                return;
            }
            
            const btn = document.getElementById('syncRequestsBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/sync/requests`, { method: 'POST' });
                const data = await response.json();
                showSuccess('Requests synced successfully!');
                await refreshData();
            } catch (error) {
                showError('Failed to sync requests: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Requests';
            }
        }

        async function importAllEpisodes() {
            if (!confirm('This will import existing episodes for ALL TV show requests. Continue?')) return;
            
            const btn = document.getElementById('importEpisodesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Importing...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/import-all-existing-episodes`, { method: 'POST' });
                const data = await response.json();
                showSuccess(data.message || 'Episodes imported successfully!');
                await refreshData();
            } catch (error) {
                showError('Failed to import episodes: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì• Import All Episodes';
            }
        }

        async function importEpisodes(requestId) {
            try {
                const response = await fetch(`${API_BASE}/admin/requests/${requestId}/import-episodes`, { method: 'POST' });
                const data = await response.json();
                showSuccess(data.message || 'Episodes imported successfully!');
                await refreshData();
            } catch (error) {
                showError('Failed to import episodes: ' + error.message);
            }
        }

        async function processNotifications() {
            const btn = document.getElementById('processNotifBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Processing...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/notifications/process`, { method: 'POST' });
                const data = await response.json();
                showSuccess('Notifications processed successfully!');
                await refreshData();
            } catch (error) {
                showError('Failed to process notifications: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìß Process Notifications';
            }
        }

        async function clearOldNotifications() {
            if (!confirm('Mark all notifications older than 24 hours as sent WITHOUT emailing? This cannot be undone!')) {
                return;
            }
            
            const btn = document.getElementById('clearOldBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Clearing...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/notifications/mark-old-as-sent?hours_old=24`, { 
                    method: 'POST' 
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(`‚úÖ Marked ${data.count} old notifications as sent (no emails sent)`);
                    await refreshData();
                } else {
                    showError(data.detail || 'Failed to clear old notifications');
                }
            } catch (error) {
                showError('Failed to clear old notifications: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Clear Old (24h+)';
            }
        }

        async function clearAllPending() {
            if (!confirm('‚ö†Ô∏è WARNING: Mark ALL pending notifications as sent WITHOUT emailing?\n\nThis will clear EVERYTHING in the queue!\n\nThis cannot be undone!')) {
                return;
            }
            
            const btn = document.getElementById('clearAllBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Clearing ALL...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/notifications/clear-all-pending`, { 
                    method: 'POST' 
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(`‚úÖ Marked ${data.count} pending notifications as sent (no emails sent)`);
                    await refreshData();
                } else {
                    showError(data.detail || 'Failed to clear pending notifications');
                }
            } catch (error) {
                showError('Failed to clear pending notifications: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö†Ô∏è Clear ALL Pending';
            }
        }

        async function sendWeeklySummary() {
            const btn = document.getElementById('summaryBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/send-weekly-summary`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Weekly summary sent! Check your email.');
                } else {
                    showError(data.detail || 'Failed to send summary');
                }
            } catch (error) {
                showError('Failed to send summary: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìä Send Summary';
            }
        }

        async function checkQualityRelease() {
            const btn = document.getElementById('qualityCheckBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/check-quality-release`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Quality/release check completed!');
                } else {
                    showError(data.detail || 'Failed to check quality/release');
                }
            } catch (error) {
                showError('Failed to check quality/release: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìÖ Check Quality/Release';
            }
        }

        async function checkStuckDownloads() {
            const btn = document.getElementById('stuckBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/check-stuck-downloads`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Checking for stuck downloads - check your email!');
                } else {
                    showError(data.detail || 'Failed to check stuck downloads');
                }
            } catch (error) {
                showError('Failed to check stuck downloads: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö†Ô∏è Check Stuck Downloads';
            }
        }

        async function refreshData() {
            await loadStats();
            await loadUsers();
            await loadRequests();
            await loadNotifications();
            await loadUpcoming();
            document.getElementById('lastSync').textContent = 'Last sync: ' + new Date().toLocaleString();
        }

        async function doLogout() {
            if (!confirm('Log out of the admin panel?')) return;
            try {
                await fetch('/auth/logout', { method: 'POST' });
            } catch(e) {}
            window.location.href = '/login';
        }

        // Check auth status to show/hide logout button
        async function checkAuthStatus() {
            try {
                const resp = await fetch('/auth/check');
                const data = await resp.json();
                if (data.auth_enabled) {
                    document.getElementById('logoutBtn').style.display = 'block';
                }
            } catch(e) {}
        }
        checkAuthStatus();

        async function runReconciliation() {
            const btn = document.getElementById('reconcileBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/reconcile`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Reconciliation check started! Check logs for results.');
                    // Refresh data after a few seconds
                    setTimeout(() => refreshData(), 5000);
                } else {
                    showError(data.detail || 'Reconciliation failed');
                }
            } catch (error) {
                showError('Failed to start reconciliation: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Check Missed';
            }
        }

        // Logs functionality
        let allLogs = '';
        let autoRefreshInterval = null;

        async function loadLogs() {
            const lines = document.getElementById('logLines').value;
            const container = document.getElementById('logsContainer');
            
            try {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Loading logs...</div>';
                
                const response = await fetch(`${API_BASE}/admin/logs?lines=${lines}`);
                const data = await response.json();
                
                if (response.ok) {
                    allLogs = data.logs;
                    renderLogs();
                    // Auto-scroll to bottom
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = `<div style="color: #f44336;">Failed to load logs: ${data.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Error loading logs: ${error.message}</div>`;
            }
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            const search = document.getElementById('logSearch').value.toLowerCase();
            
            let logs = allLogs;
            
            // Filter logs if search term provided
            if (search) {
                logs = allLogs.split('\n')
                    .filter(line => line.toLowerCase().includes(search))
                    .join('\n');
            }
            
            if (!logs.trim()) {
                container.innerHTML = '<div style="color: #999;">No logs found</div>';
                return;
            }
            
            // Colorize logs
            const colorized = logs.split('\n').map(line => {
                let color = '#e4e4e4'; // default
                
                if (line.includes('ERROR') || line.includes('CRITICAL')) {
                    color = '#f44336'; // red
                } else if (line.includes('WARNING')) {
                    color = '#ff9800'; // orange
                } else if (line.includes('INFO')) {
                    color = '#4caf50'; // green
                } else if (line.includes('DEBUG')) {
                    color = '#2196f3'; // blue
                }
                
                return `<div style="color: ${color};">${escapeHtml(line)}</div>`;
            }).join('');
            
            container.innerHTML = colorized || '<div style="color: #999;">No logs available</div>';
        }

        function filterLogs() {
            renderLogs();
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                // Stop auto-refresh
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Auto-Refresh';
                btn.style.background = 'transparent';
            } else {
                // Start auto-refresh
                autoRefreshInterval = setInterval(loadLogs, 5000); // Refresh every 5 seconds
                btn.textContent = '‚è∏Ô∏è Stop';
                btn.style.background = '#e5a00d';
                loadLogs(); // Load immediately
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function sortTable(tableName, column) {
            const state = sortState[tableName];
            
            // Toggle direction if same column, otherwise default to asc
            if (state.column === column) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = column;
                state.direction = 'asc';
            }
            
            // Update header classes
            document.querySelectorAll(`#${tableName}Tab th`).forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            event.target.classList.add(state.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort the data
            let data;
            if (tableName === 'users') data = allUsers;
            else if (tableName === 'requests') data = allRequests;
            else if (tableName === 'notifications') data = allNotifications;
            else if (tableName === 'upcoming') data = allUpcoming;
            
            data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle dates
                if (column.includes('_at') || column === 'air_date') {
                    aVal = new Date(aVal || 0);
                    bVal = new Date(bVal || 0);
                }
                
                // Handle numbers
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return state.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // Handle strings
                aVal = String(aVal || '').toLowerCase();
                bVal = String(bVal || '').toLowerCase();
                
                if (state.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return bVal < aVal ? -1 : bVal > aVal ? 1 : 0;
                }
            });
            
            // Re-render
            if (tableName === 'users') renderUsers(data);
            else if (tableName === 'requests') renderRequests(data);
            else if (tableName === 'notifications') renderNotifications(data);
            else if (tableName === 'upcoming') renderUpcoming(data);
        }

        function showSentNotifications() {
            switchTab('notifications');
            // Filter to show only sent notifications
            const sent = allNotifications.filter(n => n.sent);
            renderNotifications(sent);
        }

        async function showPendingNotifications() {
            switchTab('notifications');
            // Reload fresh data first
            await loadNotifications();
            // Filter to show only pending notifications
            const pending = allNotifications.filter(n => !n.sent);
            renderNotifications(pending);
        }

        async function showTrackingRequests() {
            switchTab('requests');
            // Reload fresh data first
            await loadRequests();
            // Filter to approved/pending requests that are not yet available
            const tracking = allRequests.filter(r => r.status !== 'available');
            renderRequests(tracking);
        }

        function showTestEmailModal() {
            const modal = document.getElementById('testEmailModal');
            modal.style.display = 'flex';
        }

        function closeTestEmailModal() {
            const modal = document.getElementById('testEmailModal');
            modal.style.display = 'none';
        }

        async function sendTestEmail() {
            const email = document.getElementById('testEmailAddress').value;
            const type = document.getElementById('testEmailType').value;
            
            if (!email) {
                showError('Please enter an email address');
                return;
            }
            
            const btn = document.getElementById('sendTestBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/test-email?email=${encodeURIComponent(email)}&notification_type=${type}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Test email sent successfully!');
                    closeTestEmailModal();
                } else {
                    showError(data.detail || 'Failed to send test email');
                }
            } catch (error) {
                showError('Failed to send test email: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Email';
            }
        }

        async function notifyEpisodeNow(requestId, seriesId, seasonNumber, episodeNumber) {
            if (!confirm(`Send notification now for this episode?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/notify-episode?request_id=${requestId}&series_id=${seriesId}&season_number=${seasonNumber}&episode_number=${episodeNumber}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Notification sent successfully!');
                    await loadUpcoming(); // Refresh upcoming list
                    await loadNotifications(); // Refresh notifications list
                    await loadStats(); // Update stats
                } else {
                    showError(data.detail || 'Failed to send notification');
                }
            } catch (error) {
                showError('Failed to send notification: ' + error.message);
            }
        }

        async function resendNotification(notificationId) {
            if (!confirm('Resend this notification?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/resend-notification/${notificationId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Notification resent successfully!');
                    await loadNotifications(); // Refresh the list
                    await loadStats(); // Update stats
                } else {
                    showError(data.detail || 'Failed to resend notification');
                }
            } catch (error) {
                showError('Failed to resend notification: ' + error.message);
            }
        }

        async function loadBackups() {
            try {
                const response = await fetch(`${API_BASE}/admin/backup/list`);
                const data = await response.json();
                renderBackups(data.backups || []);
            } catch (error) {
                console.error('Failed to load backups:', error);
                document.getElementById('backupsTableBody').innerHTML = '<tr><td colspan="4" class="empty-state">Failed to load backups</td></tr>';
            }
        }

        function renderBackups(backups) {
            const tbody = document.getElementById('backupsTableBody');
            if (backups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><div>No backups found</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = backups.map(backup => `
                <tr>
                    <td>${backup.filename}</td>
                    <td>${new Date(backup.created).toLocaleString()}</td>
                    <td>${(backup.size / 1024 / 1024).toFixed(2)} MB</td>
                    <td>
                        <button class="action-btn" onclick="downloadBackup('${backup.filename}')">‚¨áÔ∏è Download</button>
                        <button class="action-btn" onclick="deleteBackup('${backup.filename}')" style="background: rgba(244, 67, 54, 0.2); color: #f44336;">üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function createBackup() {
            const btn = document.getElementById('createBackupBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Creating backup...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/backup/create`, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Backup created successfully!');
                    await loadBackups();
                } else {
                    showError(data.detail || 'Failed to create backup');
                }
            } catch (error) {
                showError('Failed to create backup: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Create Backup';
            }
        }

        async function restoreBackup() {
            const fileInput = document.getElementById('restoreFileInput');
            if (!fileInput.files || !fileInput.files[0]) {
                showError('Please select a backup file');
                return;
            }
            
            if (!confirm('Are you sure? This will replace ALL current data with the backup. This action cannot be undone!')) {
                return;
            }
            
            const btn = document.getElementById('restoreBackupBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Restoring...';
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                const response = await fetch(`${API_BASE}/admin/backup/restore`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Backup restored! Please refresh the page.');
                    setTimeout(() => location.reload(), 3000);
                } else {
                    showError(data.detail || 'Failed to restore backup');
                }
            } catch (error) {
                showError('Failed to restore backup: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Restore Backup';
            }
        }

        function downloadBackup(filename) {
            window.location.href = `${API_BASE}/admin/backup/download/${filename}`;
        }

        async function deleteBackup(filename) {
            if (!confirm(`Delete backup ${filename}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/backup/delete/${filename}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Backup deleted');
                    await loadBackups();
                } else {
                    showError(data.detail || 'Failed to delete backup');
                }
            } catch (error) {
                showError('Failed to delete backup: ' + error.message);
            }
        }

        // Config Management Functions
        function generateSecretKey() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            const key = Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
            const input = document.getElementById('config-app-secret-key');
            input.readOnly = false;
            input.type = 'text';
            input.value = key;
            document.getElementById('config-secret-key-hint').innerHTML = '‚úÖ New key generated ‚Äî <strong>save settings and restart</strong> to apply.';
            document.getElementById('config-secret-key-hint').style.color = '#e5a00d';
        }

        function updateSecurityChecklist(config) {
            const el = document.getElementById('security-checklist');
            if (!el) return;
            const checks = [];
            
            const hasAuth = config.auth?.enabled === true;
            const hasPassword = config.auth?.has_password === true;
            const hasCidr = !!config.auth?.local_network_cidr;
            const hasWebhookIps = !!config.security?.webhook_allowed_ips;
            const isProd = config.security?.environment === 'production';
            const hasStrongKey = config.security?.secret_key_status === 'strong';
            
            checks.push(`<span style="color: ${hasAuth && hasPassword ? '#4caf50' : '#ff5252'};">${hasAuth && hasPassword ? '‚úÖ' : '‚ùå'} Authentication ${hasAuth ? 'enabled' : 'disabled'}${hasAuth && !hasPassword ? ' (no password set!)' : ''}</span>`);
            checks.push(`<span style="color: ${hasCidr ? '#4caf50' : '#ff9800'};">${hasCidr ? '‚úÖ' : '‚ö†Ô∏è'} Local network CIDR ${hasCidr ? 'configured' : 'not set'}</span>`);
            checks.push(`<span style="color: ${hasWebhookIps ? '#4caf50' : '#ff9800'};">${hasWebhookIps ? '‚úÖ' : '‚ö†Ô∏è'} Webhook IP allowlist ${hasWebhookIps ? 'configured' : 'not set (all IPs allowed)'}</span>`);
            checks.push(`<span style="color: ${isProd ? '#4caf50' : '#ff9800'};">${isProd ? '‚úÖ' : '‚ö†Ô∏è'} Environment: ${config.security?.environment || 'production'} ${!isProd ? '(API docs exposed!)' : ''}</span>`);
            checks.push(`<span style="color: ${hasStrongKey ? '#4caf50' : '#ff5252'};">${hasStrongKey ? '‚úÖ' : '‚ùå'} Secret key ${hasStrongKey ? 'is strong' : 'is weak/default ‚Äî generate a new one!'}</span>`);
            
            el.innerHTML = checks.join('<br>');
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/admin/config`);
                const config = await response.json();
                
                // Helper to split URL into host and port
                const splitUrl = (url) => {
                    if (!url) return { host: '', port: '' };
                    try {
                        const urlObj = new URL(url);
                        return {
                            host: urlObj.hostname,
                            port: urlObj.port || ''
                        };
                    } catch {
                        // If not a full URL, try to parse host:port
                        const match = url.match(/^(?:https?:\/\/)?([^:]+)(?::(\d+))?/);
                        if (match) {
                            return { host: match[1], port: match[2] || '' };
                        }
                        return { host: url, port: '' };
                    }
                };
                
                // Populate Timing fields
                document.getElementById('config-initial-delay').value = config.timing?.initial_delay_minutes || 7;
                document.getElementById('config-extension-delay').value = config.timing?.extension_delay_minutes || 3;
                document.getElementById('config-max-wait').value = config.timing?.max_wait_minutes || 20;
                document.getElementById('config-check-frequency').value = config.timing?.check_frequency_seconds || 60;
                
                // Populate SMTP fields
                document.getElementById('config-smtp-host').value = config.smtp.host || '';
                document.getElementById('config-smtp-port').value = config.smtp.port || '587';
                
                // Parse "Name <email@example.com>" format
                const smtpFrom = config.smtp.from || '';
                const emailMatch = smtpFrom.match(/^(.+?)\s*<(.+?)>$/);
                if (emailMatch) {
                    document.getElementById('config-smtp-from-name').value = emailMatch[1].trim();
                    document.getElementById('config-smtp-from-email').value = emailMatch[2].trim();
                } else {
                    document.getElementById('config-smtp-from-name').value = '';
                    document.getElementById('config-smtp-from-email').value = smtpFrom;
                }
                
                document.getElementById('config-smtp-user').value = config.smtp.user || '';
                document.getElementById('config-smtp-password').value = config.smtp.password || '';
                
                // Populate Jellyseerr fields
                const jellyseerr = splitUrl(config.jellyseerr.url);
                document.getElementById('config-jellyseerr-host').value = jellyseerr.host;
                document.getElementById('config-jellyseerr-port').value = jellyseerr.port || '5055';
                document.getElementById('config-jellyseerr-api').value = config.jellyseerr.api_key || '';
                
                // Populate Sonarr fields
                const sonarr = splitUrl(config.sonarr.url);
                document.getElementById('config-sonarr-host').value = sonarr.host;
                document.getElementById('config-sonarr-port').value = sonarr.port || '8989';
                document.getElementById('config-sonarr-api').value = config.sonarr.api_key || '';
                
                // Populate Radarr fields
                const radarr = splitUrl(config.radarr.url);
                document.getElementById('config-radarr-host').value = radarr.host;
                document.getElementById('config-radarr-port').value = radarr.port || '7878';
                document.getElementById('config-radarr-api').value = config.radarr.api_key || '';
                
                // Populate Plex fields
                const plex = splitUrl(config.plex.url);
                document.getElementById('config-plex-host').value = plex.host;
                document.getElementById('config-plex-port').value = plex.port || '32400';
                document.getElementById('config-plex-token').value = config.plex.token || '';
                
                // Populate Quality Monitoring fields
                document.getElementById('config-quality-monitor-enabled').checked = config.quality_monitor?.enabled !== false;
                document.getElementById('config-quality-monitor-interval').value = config.quality_monitor?.interval_hours || '24';
                document.getElementById('config-quality-waiting-delay').value = config.quality_monitor?.waiting_delay_seconds || '300';
                
                // Populate Issue Auto-fix fields
                document.getElementById('config-issue-autofix-mode').value = config.issue_autofix?.mode || 'manual';
                
                // Populate Reconciliation fields
                if (config.reconciliation) {
                    document.getElementById('config-recon-interval').value = config.reconciliation.interval_hours || '2';
                    document.getElementById('config-recon-fixing-cutoff').value = config.reconciliation.issue_fixing_cutoff_hours || '1';
                    document.getElementById('config-recon-reported-cutoff').value = config.reconciliation.issue_reported_cutoff_hours || '24';
                    document.getElementById('config-recon-abandon-days').value = config.reconciliation.issue_abandon_days || '7';
                }
                
                // Populate Auth fields
                if (config.auth) {
                    document.getElementById('config-auth-enabled').checked = config.auth.enabled === true;
                    document.getElementById('config-auth-password').value = '';
                    document.getElementById('config-auth-password-hint').textContent = config.auth.has_password 
                        ? '‚úÖ Password is set (leave blank to keep current)' 
                        : '‚ö†Ô∏è No password set ‚Äî set one before enabling auth';
                    document.getElementById('config-auth-local-cidr').value = config.auth.local_network_cidr || '';
                    document.getElementById('config-auth-session-timeout').value = config.auth.session_timeout_hours || '24';
                    document.getElementById('config-turnstile-enabled').checked = config.auth.turnstile_enabled === true;
                    document.getElementById('config-turnstile-site-key').value = config.auth.turnstile_site_key || '';
                    document.getElementById('config-turnstile-secret-key').value = config.auth.turnstile_secret_key || '';
                    
                    // Show/hide logout button
                    document.getElementById('logoutBtn').style.display = config.auth.enabled ? 'block' : 'none';
                }
                
                // Populate Security fields
                if (config.security) {
                    document.getElementById('config-webhook-allowed-ips').value = config.security.webhook_allowed_ips || '';
                    document.getElementById('config-environment').value = config.security.environment || 'production';
                    const secretInput = document.getElementById('config-app-secret-key');
                    secretInput.value = config.security.secret_key_status === 'strong' ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
                    secretInput.readOnly = true;
                    secretInput.type = 'password';
                    const hint = document.getElementById('config-secret-key-hint');
                    if (config.security.secret_key_status === 'strong') {
                        hint.textContent = '‚úÖ Secret key is set. Click Generate to replace it.';
                        hint.style.color = '#666';
                    } else {
                        hint.innerHTML = '‚ùå <strong>Weak or default key detected!</strong> Click Generate to create a strong key.';
                        hint.style.color = '#ff5252';
                    }
                    
                    updateSecurityChecklist(config);
                }
                
                showSuccess('Configuration loaded');
            } catch (error) {
                showError('Failed to load configuration: ' + error.message);
            }
        }

        async function saveConfig() {
            if (!confirm('‚ö†Ô∏è Save configuration changes?\n\nYou will need to restart the container for changes to take effect.\n\nContinue?')) {
                return;
            }
            
            const btn = document.getElementById('saveConfigBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Saving...';
            
            try {
                // Helper to build URL from host+port
                const buildUrl = (hostId, portId) => {
                    const host = document.getElementById(hostId).value.trim();
                    const port = document.getElementById(portId).value.trim();
                    if (!host) return '';
                    
                    // If host already has protocol, use as-is
                    if (host.startsWith('http://') || host.startsWith('https://')) {
                        return host;
                    }
                    
                    // Build URL from host:port
                    return `http://${host}${port ? ':' + port : ''}`;
                };
                
                const config = {
                    timing: {
                        initial_delay_minutes: parseInt(document.getElementById('config-initial-delay').value),
                        extension_delay_minutes: parseInt(document.getElementById('config-extension-delay').value),
                        max_wait_minutes: parseInt(document.getElementById('config-max-wait').value),
                        check_frequency_seconds: parseInt(document.getElementById('config-check-frequency').value)
                    },
                    smtp: {
                        host: document.getElementById('config-smtp-host').value,
                        port: document.getElementById('config-smtp-port').value,
                        from: (() => {
                            const name = document.getElementById('config-smtp-from-name').value.trim();
                            const email = document.getElementById('config-smtp-from-email').value.trim();
                            return name ? `${name} <${email}>` : email;
                        })(),
                        user: document.getElementById('config-smtp-user').value,
                        password: document.getElementById('config-smtp-password').value
                    },
                    jellyseerr: {
                        url: buildUrl('config-jellyseerr-host', 'config-jellyseerr-port'),
                        api_key: document.getElementById('config-jellyseerr-api').value
                    },
                    sonarr: {
                        url: buildUrl('config-sonarr-host', 'config-sonarr-port'),
                        api_key: document.getElementById('config-sonarr-api').value
                    },
                    radarr: {
                        url: buildUrl('config-radarr-host', 'config-radarr-port'),
                        api_key: document.getElementById('config-radarr-api').value
                    },
                    plex: {
                        url: buildUrl('config-plex-host', 'config-plex-port'),
                        token: document.getElementById('config-plex-token').value
                    },
                    quality_monitor: {
                        enabled: document.getElementById('config-quality-monitor-enabled').checked,
                        interval_hours: parseInt(document.getElementById('config-quality-monitor-interval').value),
                        waiting_delay_seconds: parseInt(document.getElementById('config-quality-waiting-delay').value)
                    },
                    issue_autofix: {
                        mode: document.getElementById('config-issue-autofix-mode').value
                    },
                    reconciliation: {
                        interval_hours: parseInt(document.getElementById('config-recon-interval').value),
                        issue_fixing_cutoff_hours: parseInt(document.getElementById('config-recon-fixing-cutoff').value),
                        issue_reported_cutoff_hours: parseInt(document.getElementById('config-recon-reported-cutoff').value),
                        issue_abandon_days: parseInt(document.getElementById('config-recon-abandon-days').value)
                    },
                    auth: {
                        enabled: document.getElementById('config-auth-enabled').checked,
                        password: document.getElementById('config-auth-password').value,
                        local_network_cidr: document.getElementById('config-auth-local-cidr').value,
                        session_timeout_hours: parseInt(document.getElementById('config-auth-session-timeout').value),
                        turnstile_enabled: document.getElementById('config-turnstile-enabled').checked,
                        turnstile_site_key: document.getElementById('config-turnstile-site-key').value,
                        turnstile_secret_key: document.getElementById('config-turnstile-secret-key').value
                    },
                    security: {
                        webhook_allowed_ips: document.getElementById('config-webhook-allowed-ips').value.trim(),
                        environment: document.getElementById('config-environment').value,
                        app_secret_key: (() => {
                            const input = document.getElementById('config-app-secret-key');
                            // Only send if user generated a new key (not the masked placeholder)
                            return input.readOnly ? '' : input.value;
                        })()
                    }
                };
                
                const response = await fetch(`${API_BASE}/admin/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(result.message || 'Configuration saved! Please restart the container.');
                } else {
                    showError(result.detail || 'Failed to save configuration');
                }
            } catch (error) {
                showError('Failed to save configuration: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Configuration';
            }
        }

        async function restartContainer() {
            if (!confirm('üîÑ Restart the Docker container?\n\nThis will apply any configuration changes and briefly interrupt service.\n\nContinue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/restart`, { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('Container restart initiated! Page will reload in 10 seconds...');
                    setTimeout(() => location.reload(), 10000);
                } else {
                    showError(result.detail || 'Failed to restart container');
                }
            } catch (error) {
                showError('Failed to restart: ' + error.message);
            }
        }

        async function manageSharedUsers(requestId, title) {
            // Store current request
            window.currentRequestId = requestId;
            
            // Set title
            document.getElementById('sharedUsersTitle').textContent = `Request: ${title}`;
            
            // Show modal
            const modal = document.getElementById('sharedUsersModal');
            modal.style.display = 'flex';
            
            // Load shared users and all users
            await Promise.all([
                loadSharedUsersForRequest(requestId),
                loadAllUsersForSelect()
            ]);
        }

        function closeSharedUsersModal() {
            document.getElementById('sharedUsersModal').style.display = 'none';
            window.currentRequestId = null;
        }

        async function loadSharedUsersForRequest(requestId) {
            try {
                const response = await fetch(`${API_BASE}/admin/requests/${requestId}/shared-users`);
                const data = await response.json();
                
                const container = document.getElementById('sharedUsersList');
                
                if (!data.users || data.users.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No users found</div>';
                    return;
                }
                
                container.innerHTML = data.users.map(user => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                        <div class="config-field">
                            <div style="color: #e5a00d; font-weight: 600;">${user.username}</div>
                            <div style="color: #999; font-size: 12px;">${user.email}</div>
                            ${user.is_original ? '<span style="font-size: 11px; color: #4caf50;">Original Requester</span>' : ''}
                        </div>
                        ${!user.is_original ? `<button class="action-btn" onclick="removeSharedUser(${user.user_id})" style="background: rgba(244,67,54,0.2); color: #f44336; padding: 8px 12px;">Remove</button>` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load shared users:', error);
                document.getElementById('sharedUsersList').innerHTML = '<div style="color: #f44336; padding: 20px;">Failed to load users</div>';
            }
        }

        async function loadAllUsersForSelect() {
            try {
                // Use the already loaded allUsers
                if (allUsers.length === 0) {
                    await loadUsers();
                }
                
                const select = document.getElementById('addUserSelect');
                populateCustomSelect('addUser', 
                    allUsers.map(user => ({ value: user.id, label: `${user.username} (${user.email})` })),
                    'Select a user...'
                );
                
            } catch (error) {
                console.error('Failed to load users for select:', error);
            }
        }

        async function addSharedUser() {
            const userId = document.getElementById('addUserSelect').value;
            
            if (!userId) {
                showError('Please select a user');
                return;
            }
            
            const btn = document.getElementById('addUserBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/requests/${window.currentRequestId}/share?user_id=${userId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'User added successfully!');
                    
                    // Ask if they want to notify about existing downloaded episodes
                    if (confirm('User added! Do you want to send notifications for episodes that have already been downloaded?\n\n(This will notify the new user about any episodes they missed)')) {
                        await notifyNewUserAboutExistingEpisodes(window.currentRequestId, userId);
                    }
                    
                    // Reload the shared users list
                    await loadSharedUsersForRequest(window.currentRequestId);
                    // Reload upcoming episodes to show updated user list
                    await loadUpcoming();
                    // Reset select
                    document.getElementById('addUserSelect').value = '';
                    document.getElementById('addUserDisplay').textContent = 'Select a user...';
                    document.getElementById('addUserDisplay').style.color = '#999';
                } else {
                    showError(data.detail || 'Failed to add user');
                }
            } catch (error) {
                showError('Failed to add user: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add';
            }
        }

        async function notifyNewUserAboutExistingEpisodes(requestId, userId) {
            try {
                const response = await fetch(`${API_BASE}/admin/requests/${requestId}/notify-shared-user/${userId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'Notifications sent for existing episodes!');
                } else {
                    showError(data.detail || 'Failed to send notifications');
                }
            } catch (error) {
                showError('Failed to send notifications: ' + error.message);
            }
        }

        async function removeSharedUser(userId) {
            if (!confirm('Remove this user from the request?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/requests/${window.currentRequestId}/share/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message || 'User removed successfully!');
                    // Reload the shared users list
                    await loadSharedUsersForRequest(window.currentRequestId);
                    // Reload upcoming episodes to show updated user list
                    await loadUpcoming();
                } else {
                    showError(data.detail || 'Failed to remove user');
                }
            } catch (error) {
                showError('Failed to remove user: ' + error.message);
            }
        }

        // Initialize when page loads
        window.addEventListener("load", function() {
            refreshData();
        });

        // Add User to Request Modal Functions - REMOVED (use üë• Users button instead)
        let currentRequestId = null;
        let currentRequestTitle = null;

        // Request on Behalf Modal Functions
        async function openRequestOnBehalfModal() {
            // Show modal
            document.getElementById('requestOnBehalfModal').style.display = 'flex';
            
            // Load users - force load if empty
            try {
                if (allUsers.length === 0) {
                    console.log('allUsers is empty, loading users...');
                    const response = await fetch(`${API_BASE}/admin/users?limit=1000`);
                    const data = await response.json();
                    allUsers = data.users || [];
                    console.log('Loaded', allUsers.length, 'users');
                }
                
                console.log('Populating dropdown with', allUsers.length, 'users');
                populateCustomSelect('requestBehalf',
                    allUsers.map(user => ({ value: user.jellyseerr_id, label: `${user.username} (${user.email})` })),
                    'Select a user...'
                );
                    
                console.log('Dropdown populated with', allUsers.length, 'users');
            } catch (error) {
                console.error('Failed to load users:', error);
                showError('Failed to load users: ' + error.message);
            }
        }

        function closeRequestOnBehalfModal() {
            document.getElementById('requestOnBehalfModal').style.display = 'none';
            document.getElementById('requestBehalfUrl').value = '';
        }

        async function submitRequestOnBehalf() {
            const userId = document.getElementById('requestBehalfUser').value;
            const url = document.getElementById('requestBehalfUrl').value.trim();
            
            if (!userId) {
                showError('Please select a user');
                return;
            }
            
            if (!url) {
                showError('Please enter a Jellyseerr URL');
                return;
            }
            
            // Parse URL to extract media type and TMDB ID
            // Format: http://jellyseerr:5055/movie/12345 or /tv/67890
            const match = url.match(/\/(movie|tv)\/(\d+)/);
            if (!match) {
                showError('Invalid URL format. Expected: .../movie/12345 or .../tv/67890');
                return;
            }
            
            const mediaType = match[1];
            const tmdbId = parseInt(match[2]);
            
            try {
                const response = await fetch(`${API_BASE}/admin/request-on-behalf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jellyseerr_user_id: parseInt(userId),
                        tmdb_id: tmdbId,
                        media_type: mediaType
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create request');
                }
                
                const result = await response.json();
                showSuccess('Request created successfully!');
                closeRequestOnBehalfModal();
                loadRequests(); // Refresh
            } catch (error) {
                showError(error.message);
            }
        }
    </script>

    <!-- Request on Behalf Modal -->
    <div id="requestOnBehalfModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <h2 style="margin-bottom: 20px; color: #8a2be2;">üé¨ Request Content for User</h2>
            
            <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8a2be2;">
                <strong style="color: #8a2be2;">How to use:</strong><br>
                <span style="color: #999; font-size: 13px;">
                    1Ô∏è‚É£ Open Jellyseerr and find the movie/show<br>
                    2Ô∏è‚É£ Copy the URL (e.g., http://jellyseerr:5055/movie/12345)<br>
                    3Ô∏è‚É£ Paste it below and select the user<br>
                </span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999;">Select User</label>
                <div id="requestBehalfUserWrap" class="custom-select-wrap" style="width: 100%;">
                    <div class="custom-select-display" id="requestBehalfDisplay" onclick="toggleCustomSelect('requestBehalf', event)">Loading users...</div>
                    <div class="custom-select-options" id="requestBehalfOptions"></div>
                    <input type="hidden" id="requestBehalfUser" value="">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999;">Jellyseerr Content URL</label>
                <input type="text" id="requestBehalfUrl" placeholder="http://jellyseerr:5055/movie/12345 or .../tv/67890" 
                       style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e4e4e4;">
                <small style="color: #666; font-size: 11px;">Supports /movie/[id] and /tv/[id] URLs</small>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="submitRequestOnBehalf()" class="primary" style="flex: 1;">Create Request</button>
                <button onclick="closeRequestOnBehalfModal()" class="secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    // Position and open a custom dropdown
    function positionDropdown(display, options) {
        const rect = display.getBoundingClientRect();
        options.style.top = (rect.bottom + 4) + 'px';
        options.style.left = rect.left + 'px';
        options.style.width = rect.width + 'px';
    }

    // Custom dropdown toggle for dynamic selects (modals)
    function toggleCustomSelect(name, evt) {
        if (evt) evt.stopPropagation();
        const display = document.getElementById(name + 'Display');
        const options = document.getElementById(name + 'Options');
        document.querySelectorAll('.custom-select-options.open').forEach(o => {
            if (o !== options) o.classList.remove('open');
        });
        if (!options.classList.contains('open')) {
            positionDropdown(display, options);
        }
        options.classList.toggle('open');
    }

    function populateCustomSelect(name, items, placeholderText) {
        const display = document.getElementById(name + 'Display');
        const options = document.getElementById(name + 'Options');
        const hidden = document.getElementById(name === 'addUser' ? 'addUserSelect' : 'requestBehalfUser');
        
        display.textContent = placeholderText;
        hidden.value = '';
        options.innerHTML = '';
        
        // Add placeholder option
        const placeholder = document.createElement('div');
        placeholder.className = 'custom-select-option';
        placeholder.textContent = placeholderText;
        placeholder.style.color = '#666';
        placeholder.addEventListener('click', (e) => {
            e.stopPropagation();
            hidden.value = '';
            display.textContent = placeholderText;
            display.style.color = '#999';
            options.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
            options.classList.remove('open');
        });
        options.appendChild(placeholder);
        
        items.forEach(item => {
            const opt = document.createElement('div');
            opt.className = 'custom-select-option';
            opt.textContent = item.label;
            opt.dataset.value = item.value;
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                hidden.value = item.value;
                display.textContent = item.label;
                display.style.color = '#e4e4e4';
                options.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                options.classList.remove('open');
            });
            options.appendChild(opt);
        });
    }

    // Custom dropdown replacement for static selects (settings page)
    function initCustomSelects() {
        // Skip dynamic custom dropdowns (already handled)
        const skipIds = ['addUserSelect', 'requestBehalfUser'];
        
        document.querySelectorAll('select').forEach(select => {
            if (skipIds.includes(select.id)) return;
            // Skip already converted
            if (select.dataset.customized) return;
            
            select.dataset.customized = 'true';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select-wrap';
            
            const display = document.createElement('div');
            display.className = 'custom-select-display';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'custom-select-options';
            
            // Build options
            function buildOptions() {
                optionsDiv.innerHTML = '';
                Array.from(select.options).forEach((opt, i) => {
                    const optEl = document.createElement('div');
                    optEl.className = 'custom-select-option' + (i === select.selectedIndex ? ' selected' : '');
                    optEl.textContent = opt.textContent;
                    optEl.dataset.value = opt.value;
                    optEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        select.value = opt.value;
                        select.dispatchEvent(new Event('change'));
                        display.textContent = opt.textContent;
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                        optEl.classList.add('selected');
                        optionsDiv.classList.remove('open');
                    });
                    optionsDiv.appendChild(optEl);
                });
            }
            
            buildOptions();
            
            // Set initial display text
            display.textContent = select.options[select.selectedIndex]?.textContent || 'Select...';
            
            // Toggle dropdown
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close all other open dropdowns
                document.querySelectorAll('.custom-select-options.open').forEach(o => {
                    if (o !== optionsDiv) o.classList.remove('open');
                });
                if (!optionsDiv.classList.contains('open')) {
                    positionDropdown(display, optionsDiv);
                }
                optionsDiv.classList.toggle('open');
            });
            
            // Hide original select visually but keep it in DOM for form data
            select.style.position = 'absolute';
            select.style.opacity = '0';
            select.style.pointerEvents = 'none';
            select.style.height = '0';
            select.style.overflow = 'hidden';
            
            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(display);
            wrapper.appendChild(optionsDiv);
            wrapper.appendChild(select);
            
            // Watch for programmatic value changes (e.g. loadConfig)
            const origDescriptor = Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype, 'value');
            Object.defineProperty(select, 'value', {
                get() { return origDescriptor.get.call(this); },
                set(val) {
                    origDescriptor.set.call(this, val);
                    const opt = Array.from(this.options).find(o => o.value == val);
                    if (opt) {
                        display.textContent = opt.textContent;
                        optionsDiv.querySelectorAll('.custom-select-option').forEach(o => {
                            o.classList.toggle('selected', o.dataset.value == val);
                        });
                    }
                }
            });
        });
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
        document.querySelectorAll('.custom-select-options.open').forEach(o => o.classList.remove('open'));
    });
    
    // Initialize after DOM ready and after config loads
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initCustomSelects, 500);
    });
    
    // Re-init after config loads (selects might have new values)
    const origLoadConfig = window.loadConfig;
    if (origLoadConfig) {
        window.loadConfig = async function() {
            await origLoadConfig();
            setTimeout(initCustomSelects, 100);
        };
    }
    </script>
</body>
</html>
